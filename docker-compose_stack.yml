services:
  gluetun:
    container_name: gluetun
    image: qmcgaw/gluetun:latest
    cap_add:
      - NET_ADMIN
    environment:
      VPN_SERVICE_PROVIDER: protonvpn
      VPN_TYPE: wireguard
      VPN_PORT_FORWARDING: on
      WIREGUARD_PRIVATE_KEY: your_private_key
      WIREGUARD_ADDRESSES: your_wireguard_ip
      SERVER_COUNTRIES: Netherlands
      # Control server config for qSticky
      GLUETUN_HTTP_CONTROL_SERVER_ENABLE: on
      GLUETUN_HTTP_CONTROL_SERVER_PORT: 8000
      GLUETUN_HTTP_CONTROL_SERVER_APIKEY: your_api_key_here
    volumes:
      - ./gluetun/config.toml:/gluetun/auth/config.toml # https://github.com/qdm12/gluetun-wiki/blob/main/setup/advanced/control-server.md#authentication
    ports:
      - 8080:8080  # qBittorrent WebUI
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/v1/openvpn/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: on-failure

  qbittorrent:
    container_name: qbittorrent
    image: linuxserver/qbittorrent:latest
    network_mode: container:gluetun
    environment:
      PUID: 1000
      PGID: 1000
      TZ: UTC
      WEBUI_PORT: 8080
    volumes:
      - ./qbittorrent/config:/config
      - ./downloads:/downloads
    healthcheck:
      test: ["CMD-SHELL", "curl -sf https://api.ipify.org || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
      start_interval: 5s
    restart_policy: on-failure
    depends_on:
      - gluetun

  qSticky:
    container_name: qSticky
    image: ghcr.io/monstermuffin/qSticky:latest
    network_mode: container:gluetun
    environment:
      # qBittorrent settings
      QBITTORRENT_HOST: localhost
      QBITTORRENT_HTTPS: false
      QBITTORRENT_PORT: 8080
      QBITTORRENT_USER: admin
      QBITTORRENT_PASS: adminadmin
      # Gluetun settings
      GLUETUN_AUTH_TYPE: apikey # https://github.com/qdm12/gluetun-wiki/blob/main/setup/advanced/control-server.md#authentication
      GLUETUN_APIKEY: your_api_key_here
      # qSticky settings
      LOG_LEVEL: INFO
    healthcheck:
      test: ["CMD", "cat", "/tmp/health/status.json"]
      interval: 1m
      timeout: 10s
      retries: 3
    restart: on-failure
    depends_on:
      - gluetun
      - qbittorrent